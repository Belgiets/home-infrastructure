version: '3.8'

services:
  ftp-server:
    image: fauria/vsftpd:latest
    container_name: camera-ftp-prod
    ports:
      - "20:20"
      - "21:21"
      - "21100-21110:21100-21110"  # Passive mode ports
    volumes:
      - ftp-data:/home/vsftpd/camera
    environment:
      FTP_USER: camera
      FTP_PASS: ${FTP_PASSWORD}  # Set via environment variable
      PASV_ADDRESS: ${VM_EXTERNAL_IP}  # Will be set by Terraform
      PASV_MIN_PORT: 21100
      PASV_MAX_PORT: 21110
      LOCAL_UMASK: 022
    restart: unless-stopped
    networks:
      - camera-network
    logging:
      driver: "gcplogs"
      options:
        gcp-project: ${GCP_PROJECT_ID}
        gcp-log-cmd: "true"

  watcher:
    build:
      context: ./watcher
      dockerfile: Dockerfile
    container_name: camera-watcher-prod
    volumes:
      - ftp-data:/watch-dir
    environment:
      - NODE_ENV=production
      - WATCH_DIR=/watch-dir
      - GCS_BUCKET=${GCS_BUCKET_PROD}
      - DELETE_AFTER_UPLOAD=true  # Clean up after successful upload
      - LOG_LEVEL=info
    depends_on:
      - ftp-server
    restart: unless-stopped
    networks:
      - camera-network
    logging:
      driver: "gcplogs"
      options:
        gcp-project: ${GCP_PROJECT_ID}
        gcp-log-cmd: "true"

volumes:
  ftp-data:

networks:
  camera-network:
    driver: bridge